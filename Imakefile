XCOMM $Id: Imakefile,v 1.22 1995-05-24 21:26:53 granger Exp $
XCOMM
XCOMM This is the top-level Imakefile for the Zebra distribution.
XCOMM It is modeled after the top-level Imakefile of the MIT X11R5
XCOMM distribution.

#define IHaveSubdirs
#define PassCDebugFlags

      WORLDOPTS = -k

#if BuildRDSS
    RDSSSUBDIRS = util ui
#endif
        SUBDIRS = config $(RDSSSUBDIRS) src
    DISTSUBDIRS = config $(RDSSSUBDIRS) src
     SRCSUBDIRS = config $(RDSSSUBDIRS) src

          ETAGS = etags
     ETAGSFLAGS = 

        ZIPPIPE = gzip -c
         ZIPEXT = gz

XCOMM Note that for distributions, Makefile should be a copy of 
XCOMM Makefile.ini and NOT the Makefile created by imake.  The tarfile
XCOMM target copies Makefile.ini over Makefile automatically.

      DISTFILES = Imakefile Makefile.ini /*Makefile*/ ChangeLog
#ifdef notdef
       LINKDIRS = dist/zeb/doc dist/zeb/project
      LINKNAMES = $(TARNAME)/doc $(TARNAME)/project
#endif
       LINKDIRS = /* docs and projects will be distributed separately */
      LINKNAMES = 

XCOMM From the top-level directory, the default behavior will be the same
XCOMM as the "Everything" target, i.e. make sure all Makefiles are
XCOMM up-to-date, do includes, depends, and finally install.  The
XCOMM difference between World and Everything is that Everything does not
XCOMM do a clean first.
XCOMM 
XCOMM If someone really wants to do an 'all', they have to ask for it 
XCOMM explicitly.  Now that UseInstalledZeb exists and can be set to NO,
XCOMM a 'make all' is a reasonable thing to do.

default::
	@echo "The default target is 'Everything'."
	@echo "There are two principle top-level make targets available:"
	@echo "The 'Everything' target performs:"
	@echo "	make Makefile"
	@echo "	make Makefiles"
	@echo "	make includes"
	@echo "	make depend"
	@echo "	make install"
	@echo "The 'World' target performs:"
	@echo "	make Makefile"
	@echo "	make Makefiles"
	@echo "	make clean"
	@echo "	make includes"
	@echo "	make depend"
	@echo "	make install"
	@echo "If you are installing Zebra for the first time, break"
	@echo "out of this make by typing Ctl-C.  Make sure you have"
	@echo "read and performed the configuration instructions,"
	@echo "and then enter the command: 'make World'."
	@echo "You can enter any of the targets Makefile, Makefiles, clean,"
	@echo "includes, depend, all, or install on the make command line,"
	@echo "but you risk compiling with outdated header or object files."
	@echo "Other targets available:"
	@echo "	make distclean      - clean all subdirectories, "
	@echo "			      including ./include"
	@echo "	make tarfile        - make a tar file of the distribution,"
	@echo "	                      see Imakefile for info before using"
	@echo "Press <Return> here to continue with 'make Everything',"
	@echo "or press <Ctl-C> to abort."
	@line

default:: Everything

MakeSubdirs($(SUBDIRS))
DependSubdirs($(SUBDIRS))
/*InstallLibSubdirs($(SUBDIRS))*/	/* No longer used */

DistfilesTarget($(DISTFILES))
DistfilesSubdirs($(DISTSUBDIRS))

TESTSUBDIRS = src

TestSubdirs($(TESTSUBDIRS))

XCOMM do not name your log file make.log or MakeOut when you run this ...
World::
	@echo ""
	@echo "Building Zebra"
	@echo "Do not name your log file make.log or MakeOut,"
	@echo "else it will be erased."
	@date
	@echo ""
	cd $(IMAKESRC); \
		$(MAKE) -f Makefile.ini MAKE=$(MAKE) $(MFLAGS) clean; \
		$(MAKE) -f Makefile.ini MAKE=$(MAKE) $(MFLAGS) \
			INCLUDES=-I../project \
			BOOTSTRAPCFLAGS="$(BOOTSTRAPCFLAGS)" CC="$(CC)"
	-$(RM) Makefile.bak; $(MV) Makefile Makefile.bak
	$(MAKE) MAKE=$(MAKE) $(MFLAGS) -f Makefile.bak Makefile
	$(MAKE) MAKE=$(MAKE) $(MFLAGS) Makefiles
	$(MAKE) MAKE=$(MAKE) $(MFLAGS) clean
	$(MAKE) MAKE=$(MAKE) $(MFLAGS) includes
	$(MAKE) MAKE=$(MAKE) $(MFLAGS) depend
	$(MAKE) MAKE=$(MAKE) $(MFLAGS) $(WORLDOPTS) install
	@echo ""
	@date
	@echo ""
	@echo "Zebra build complete."
	@echo ""

Everything::
	@echo ""
	@echo "Rebuilding Zebra"
	@echo ""
	@date
	@echo ""
	cd $(IMAKESRC); \
		$(MAKE) $(MFLAGS) -f Makefile.ini \
		BOOTSTRAPCFLAGS="$(BOOTSTRAPCFLAGS)" CC="$(CC)"
	-$(RM) Makefile.bak; $(MV) Makefile Makefile.bak
	$(MAKE) MAKE=$(MAKE) $(MFLAGS) -f Makefile.bak Makefile
	$(MAKE) MAKE=$(MAKE) $(MFLAGS) Makefiles
	$(MAKE) MAKE=$(MAKE) $(MFLAGS) includes
	$(MAKE) MAKE=$(MAKE) $(MFLAGS) depend
	$(MAKE) MAKE=$(MAKE) $(MFLAGS) $(WORLDOPTS) install
	@echo ""
	@date
	@echo ""
	@echo "Zebra rebuild complete"
	@echo ""

/*
 * Some probably wouldn't want a simple 'make clean' to remove
 * the ./include directory, and since this is the natural
 * distribution state, this is called the 'distclean' target:
 */
distclean::
	$(RM) -rf $(TOP)/include

/*
 * This is the top-level rule for generating tar files of the distributed
 * files.  The list of files to tar is gotten from the distfiles target.
 * The name of the tarfile can be changed by setting the TARFILE variable
 * on the command line.
 *
 * The -s (silent) option is necessary to get GNU make to not print out
 * its commands for automatically checking for or checking out files.
 * This option is compatible with Sun's make, but others...?
 * Since development is being done on Suns, this is not much of a concern.
 *
 * The tarfile (aka distfile) target packages the complete distribution,
 * including config, project, and document directories.
 * 
 * The srcfile target is intended for developers who only to
 * compile the source only.  This tar file will include only what
 * is necessary to compile and install all of the executables.
 * To further restrict what is packaged, set the DISTSUBDIRS
 * variable from the command line, e.g.
 *
 * 	make srcfile SRCNAME=pikes-copy \
 *		SRCSUBDIRS="imake config src/msg"
 */
TARFILE = zebra-4.0
SRCFILE = zebra-src

tarfile:
	@echo Making file $(TARFILE).tar.$(ZIPEXT) ; \
	if mkdir $(TARFILE) ; then \
	  (set -x; \
	   cd $(TARFILE); \
	        for f in $(DISTFILES) $(LINKDIRS) $(DISTSUBDIRS); do \
		  $(LN) ../$$f . ; \
		done; \
		rm -f Makefile ; \
		cp ../Makefile.ini Makefile \
	  ) ; \
	  tar cvhf - $(LINKNAMES) \
	     `$(MAKE) MAKE=$(MAKE) $(MFLAGS) -s DISTCURDIR=$(TARFILE) distfiles` | \
		  $(ZIPPIPE) > $(TARFILE).tar.$(ZIPEXT) ; \
	  rm -rf $(TARFILE) ; \
	  echo Done making $(TARFILE).tar.$(ZIPEXT) ; \
	else \
	  echo "Cannot make directory '$(TARFILE)'!  Aborting."; \
	  false ; \
	fi

srcfile:
	@echo Making file $(SRCFILE).tar.$(ZIPEXT) ; \
	if mkdir $(SRCFILE) ; then \
	  (set -x; \
	   cd $(SRCFILE); for f in $(DISTFILES) $(SRCSUBDIRS); do \
		  $(LN) ../$$f . ; \
	  done) ; \
	  tar cvhf - \
	     `$(MAKE) MAKE=$(MAKE) $(MFLAGS) -s DISTCURDIR=$(SRCFILE) \
	      DISTSUBDIRS="$(SRCSUBDIRS)" distfiles ` | \
		  $(ZIPPIPE) > $(SRCFILE).tar.$(ZIPEXT) ; \
	  rm -rf $(SRCFILE) ; \
	  echo Done making $(SRCFILE).tar.$(ZIPEXT) ; \
	else \
	  echo "Cannot make directory '$(SRCFILE)'!  Aborting."; \
	  false ; \
	fi

/*
 * Since the mf shortcut turns around and does a depend as well, we'll
 * more-than-likely want to disable the depend part. Just do the
 * Makefile part and then quit
 */
mf:: Makefile
	@echo "Skipping the depend part of this target."
	@echo "Use 'make depend' to perform depend on all subdirectories."
	@false

XCOMM clean out link tree looking for stuff that should get checked in
flushlinks::
	make -k clean
	find . -type l -exec rm {} \;
	find . \( \! \( -type d -o -name Makefile \) \) -print

XCOMM Quick and dirty generation of emacs tags file for Zebra source tree
etags::
	$(ETAGS) $(ETAGSFLAGS) `find src -name "*.[ch]" -print`

